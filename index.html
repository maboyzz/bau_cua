<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game B·∫ßu Cua Ultimate - NT Huy</title>
    <style>
        :root {
            --primary-color: #D32F2F;
            --accent-color: #FFC107;
            --secondary-color: #FFF9C4;
            --success-color: #388E3C;
            --text-color: #333;
            --bg-gradient-1: #FF5252;
            --bg-gradient-2: #D32F2F;
        }

        * {
            box-sizing: border-box;
        }

        /* ƒê·∫£m b·∫£o padding kh√¥ng l√†m v·ª° khung */

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-1), var(--bg-gradient-2));
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            /* Gi·∫£m padding tr√™n mobile */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            /* B·ªè highlight khi tap tr√™n mobile */
        }

        /* --- CANVAS PH√ÅO HOA --- */
        #fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            pointer-events: none;
        }

        /* --- TUTORIAL OVERLAY --- */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            padding: 20px;
        }

        .tutorial-box {
            background: white;
            width: 500px;
            max-width: 100%;
            padding: 20px;
            border-radius: 20px;
            border: 4px solid var(--accent-color);
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.5);
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
            /* Cho ph√©p cu·ªôn n·∫øu m√†n h√¨nh qu√° b√© */
        }

        .tutorial-step h2 {
            color: var(--primary-color);
            margin-top: 0;
            font-size: 22px;
        }

        .tutorial-step ul {
            padding-left: 20px;
        }

        .tutorial-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
            box-shadow: 0 4px 0 #9e1c1c;
            width: 100%;
        }

        .tutorial-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .step-dots {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .dot {
            width: 10px;
            height: 10px;
            background: #ddd;
            border-radius: 50%;
        }

        .dot.active {
            background: var(--primary-color);
        }

        /* --- Header --- */
        .header-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            /* X·∫øp d·ªçc tr√™n mobile */
            align-items: center;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid var(--accent-color);
            z-index: 10;
            position: relative;
        }

        /* M√†n h√¨nh l·ªõn th√¨ x·∫øp ngang */
        @media (min-width: 768px) {
            .header-container {
                flex-direction: row;
                justify-content: space-between;
            }
        }

        h1 {
            color: var(--primary-color);
            margin: 0;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.1);
            font-size: 1.5em;
            text-align: center;
        }

        .header-right {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        @media (min-width: 768px) {
            .header-right {
                width: auto;
            }
        }

        .btn-icon,
        button {
            background-color: var(--primary-color);
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 3px 0 #9e1c1c;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            white-space: nowrap;
            flex: 1;
            /* N√∫t t·ª± co gi√£n */
        }

        .btn-icon:active,
        button:active {
            transform: translateY(3px);
            box-shadow: none;
        }

        /* --- Layout Ch√≠nh --- */
        .container {
            display: grid;
            grid-template-columns: 1fr;
            /* M·∫∑c ƒë·ªãnh 1 c·ªôt (Mobile) */
            gap: 15px;
            max-width: 1200px;
            width: 100%;
            transition: all 0.3s;
            z-index: 10;
            position: relative;
        }

        /* M√†n h√¨nh l·ªõn chia 2 c·ªôt */
        @media (min-width: 900px) {
            .container {
                grid-template-columns: 3fr 1fr;
            }
        }

        .game-board,
        .sidebar {
            background: var(--secondary-color);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border: 4px solid var(--accent-color);
        }

        .sidebar {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Mobile cho ng·∫Øn l·∫°i */
        @media (min-width: 900px) {
            .sidebar {
                max-height: 800px;
            }
        }

        /* --- Khu v·ª±c Nh√† C√°i & X√∫c X·∫Øc --- */
        .dealer-section {
            text-align: center;
            border-bottom: 2px dashed var(--primary-color);
            padding-bottom: 20px;
            margin-bottom: 20px;
            position: relative;
            min-height: 220px;
        }

        #dealer-name-display {
            color: var(--primary-color);
            font-size: 1.3em;
            margin: 0;
            font-weight: bold;
            text-transform: uppercase;
        }

        #dealer-balance {
            font-weight: bold;
            color: #c0392b;
            font-size: 1.1em;
        }

        .dice-area {
            position: relative;
            width: 100%;
            max-width: 300px;
            height: 120px;
            margin: 30px auto 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .dice {
            width: 60px;
            height: 60px;
            background-color: white;
            border: 2px solid #ccc;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            box-shadow: 0 4px 0 #bdc3c7;
            z-index: 1;
        }

        @media (min-width: 768px) {
            .dice {
                width: 80px;
                height: 80px;
                font-size: 50px;
            }

            .dice-area {
                height: 150px;
                gap: 15px;
            }
        }

        /* Xoay x√∫c x·∫Øc */
        @keyframes spinDice {
            0% {
                transform: translateY(0) rotate(0deg);
            }

            100% {
                transform: translateY(0) rotate(360deg);
            }
        }

        .dice.shaking {
            animation: spinDice 0.5s infinite linear;
        }

        /* --- C√°i B√°t (Responsive) --- */
        #the-bowl {
            width: 260px;
            height: 260px;
            /* Mobile size */
            background-image: url('cai-bat.png');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            position: absolute;
            top: -70px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            cursor: grab;
            transition: top 0.5s ease-out, opacity 0.3s;
        }

        @media (min-width: 768px) {
            #the-bowl {
                width: 400px;
                height: 400px;
                top: -85px;
            }

            /* PC Size */
        }

        #the-bowl:active {
            cursor: grabbing;
        }

        .bowl-open {
            top: -600px !important;
            opacity: 0;
            pointer-events: none;
        }

        /* --- B√†n C∆∞·ª£c --- */
        .betting-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .bet-option {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            position: relative;
        }

        .bet-option:hover {
            border-color: var(--accent-color);
            background: #fffce0;
        }

        .bet-option.selected {
            border-color: var(--primary-color);
            background: #ffebee;
            box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.3);
        }

        .symbol-icon {
            font-size: 30px;
            display: block;
        }

        .symbol-name {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 14px;
        }

        .current-bet-display {
            font-size: 0.8em;
            color: var(--success-color);
            font-weight: bold;
            min-height: 1.2em;
        }

        @media (min-width: 768px) {
            .symbol-icon {
                font-size: 40px;
            }

            .symbol-name {
                font-size: 16px;
            }

            .bet-option {
                padding: 10px;
            }
        }

        /* --- Controls --- */
        .controls {
            background: rgba(255, 255, 255, 0.7);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #ddd;
        }

        .controls h3 {
            margin-top: 0;
            font-size: 1.1em;
            text-align: center;
            color: #555;
        }

        .control-row {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }

        @media (min-width: 500px) {
            .control-row {
                flex-direction: row;
                align-items: center;
            }
        }

        .control-row label {
            font-weight: bold;
            color: #555;
            min-width: 80px;
        }

        select,
        input {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
            outline: none;
            width: 100%;
        }

        select:focus,
        input:focus {
            border-color: var(--primary-color);
        }

        #btn-action {
            width: 100%;
            font-size: 18px;
            padding: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
        }

        #btn-action.btn-open {
            background-color: var(--success-color);
            border-color: #2e7d32;
            box-shadow: 0 4px 0 #1b5e20;
        }

        /* --- Player Info --- */
        .player-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
            margin-bottom: 5px;
            border-radius: 5px;
            font-size: 14px;
        }

        .player-card.dealer {
            background: #ffebee;
            font-weight: bold;
        }

        .money-value {
            font-family: monospace;
            font-size: 1.1em;
        }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
            padding: 10px;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            width: 550px;
            max-width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            border-bottom: 2px solid #eee;
            margin-bottom: 15px;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.2em;
        }

        .form-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 10px;
        }

        @media (min-width: 500px) {
            .form-group {
                grid-template-columns: 0.5fr 2fr 1.5fr 1fr;
                gap: 10px;
                border-bottom: none;
                padding-bottom: 0;
            }
        }

        .modal-footer {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;

            display: flex;
            justify-content: center;
            /* ƒë·∫©y n√∫t v·ªÅ b√™n ph·∫£i */
            gap: 10px;
            /* kho·∫£ng c√°ch gi·ªØa 2 n√∫t */
        }

        /* Rule Styles */
        .rule-item h3 {
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .rule-item p {
            font-size: 14px;
            margin: 0 0 10px 0;
        }

        .falling-flower {
            position: fixed;
            top: -10%;
            z-index: 0;
            pointer-events: none;
            animation: fall-down linear;
            font-size: 20px;
        }

        @keyframes fall-down {
            0% {
                top: -10%;
                transform: translateX(0) rotate(0deg);
                opacity: 1;
            }

            100% {
                top: 110%;
                transform: translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }

        .music-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            border: 2px solid var(--primary-color);
            transition: all 0.3s;
        }

        .music-control:hover {
            transform: scale(1.1);
        }

        .music-icon {
            font-size: 20px;
        }
    </style>
</head>

<body>
    <canvas id="fireworks-canvas"></canvas>

    <div id="tutorial-overlay" class="tutorial-overlay">
        <div class="tutorial-box">
            <div id="step-1" class="tutorial-step">
                <h2>üéâ Ch√†o M·ª´ng!</h2>
                <p>ƒê·∫øn v·ªõi con game b·∫ßu c·ªßa c·ªßa NT Huy</p>
                <div style="background: #FFF9C4; padding: 10px; border-radius: 10px; margin: 15px 0;">
                    <p>Nh·∫•n <b>‚öôÔ∏è C√†i ƒë·∫∑t</b> ƒë·ªÉ ch·ªânh T√™n & Ti·ªÅn.</p>
                </div>
                <button class="tutorial-btn" onclick="showStep2()">Ti·∫øp Theo ‚û°Ô∏è</button>
                <div class="step-dots"><span class="dot active"></span><span class="dot"></span></div>
            </div>
            <div id="step-2" class="tutorial-step" style="display: none;">
                <h2>üé≤ H∆∞·ªõng D·∫´n C√°ch Ch∆°i</h2>
                <ul style="text-align: left; margin: 15px 0; font-size: 15px;">
                    <li><b>B∆∞·ªõc 1:</b> Ch·ªçn ng∆∞·ªùi v√† ƒë·∫∑t ti·ªÅn v√†o c·ª≠a c∆∞·ª£c.</li>
                    <li><b>B∆∞·ªõc 2:</b> Nh·∫•n <b>X√ìC</b> ƒë·ªÉ l·∫Øc x√∫c x·∫Øc.</li>
                    <li><b>B∆∞·ªõc 3:</b> Nh·∫•n n√∫t M·ªü ho·∫∑c <b>k√©o c√°i b√°t</b> ƒë·ªÉ xem k·∫øt qu·∫£.</li>
                    <li><b>‚ú® M·ªõi:</b> Nh·∫•n n√∫t <b>üìñ C√°ch Ch∆°i</b> ·ªü tr√™n ƒë·ªÉ xem lu·∫≠t chi ti·∫øt b·∫•t c·ª© l√∫c n√†o!</li>
                </ul>
                <button class="tutorial-btn" onclick="finishTutorial()">B·∫Øt ƒê·∫ßu Ch∆°i üéµ</button>
                <div class="step-dots"><span class="dot"></span><span class="dot active"></span></div>
            </div>
        </div>
    </div>

    <audio id="bg-audio" loop>
        <source src="nhac-tet.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-clap">
        <source src="vo-tay.mp3" type="audio/mpeg">
    </audio>

    <div class="music-control" onclick="toggleMusic()">
        <span class="music-icon" id="music-icon">üîá</span>
        <span style="font-weight:bold; font-size:14px; color: var(--primary-color)">Nh·∫°c</span>
    </div>

    <div class="header-container">
        <h1>üé≤ B·∫ßu Cua Ultimate - NT Huy</h1>
        <div class="header-right">
            <button class="btn-icon" onclick="openRules()">üìñ C√°ch Ch∆°i</button>
            <button class="btn-icon" onclick="toggleMoney()">üí∞ <span id="money-status">Hi·ªán</span></button>
            <button class="btn-icon" onclick="toggleSidebar()" id="btn-sidebar">üìú <span
                    id="history-status">Hi·ªán</span></button>
            <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è C√†i ƒë·∫∑t</button>
        </div>
    </div>

    <div class="container" id="main-container">
        <div class="game-board">
            <div class="dealer-section">
                <h3 id="dealer-name-display">Nh√† C√°i</h3>
                <div id="dealer-balance" class="money-value">Ti·ªÅn: 0 $</div>
                <div class="dice-area">
                    <div class="dice" id="d1">?</div>
                    <div class="dice" id="d2">?</div>
                    <div class="dice" id="d3">?</div>
                    <div id="the-bowl" class="bowl-open" title="K√©o t√¥i!"></div>
                </div>
            </div>

            <div class="betting-grid" id="betting-board"></div>

            <div class="controls">
                <h3>Khu V·ª±c ƒê·∫∑t C∆∞·ª£c</h3>
                <div class="control-row">
                    <label>Ng∆∞·ªùi ch∆°i:</label>
                    <select id="player-select"></select>
                    <span id="current-player-balance" class="money-value"
                        style="font-weight: bold; color: var(--success-color)"></span>
                </div>
                <div class="control-row">
                    <label>C·ª≠a c∆∞·ª£c:</label>
                    <input type="text" id="selected-symbol-name" readonly placeholder="Ch·ªçn h√¨nh tr√™n" style="flex:1"
                        onclick="alert('H√£y b·∫•m v√†o h√¨nh B·∫ßu/Cua... ·ªü tr√™n ƒë·ªÉ ch·ªçn!')">
                    <input type="hidden" id="selected-symbol-index">
                </div>
                <div class="control-row">
                    <label>Ti·ªÅn c∆∞·ª£c:</label>
                    <input type="number" id="bet-amount" placeholder="Nh·∫≠p ti·ªÅn" min="1" step="10">
                    <button onclick="handlePlaceBet()" style="white-space:nowrap">X√°c nh·∫≠n</button>
                </div>
                <button id="btn-action" onclick="handleGameAction()">X√ìC (ƒê√≥ng B√°t)</button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <h3>Danh s√°ch & L·ªãch s·ª≠</h3>
            <div id="player-list" class="balance-info"></div>
            <hr>
            <div id="game-log"></div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>C√†i ƒê·∫∑t</h2><span style="font-size:24px;cursor:pointer" onclick="closeSettings()">&times;</span>
            </div>
            <div id="settings-body">
                <h4 style="color:var(--accent-color); margin:5px 0;">Nh√† C√°i</h4>
                <div class="form-group"><label>T√™n:</label><input type="text" id="set-dealer-name"></div>
                <div class="form-group"><label>Ti·ªÅn:</label><input type="number" id="set-dealer-money"></div>
                <hr>
                <h4 style="color:var(--primary-color); margin:5px 0;">Ng∆∞·ªùi Ch∆°i</h4>
                <div id="players-settings-container"></div>
            </div>
            <div class="modal-footer"><button onclick="saveSettings()" style="width:100%">L∆∞u Thay ƒê·ªïi</button></div>
        </div>
    </div>

    <div id="rules-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìñ Lu·∫≠t Ch∆°i Chi Ti·∫øt</h2>
                <span style="cursor:pointer; font-size:24px" onclick="closeRules()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="rule-item">
                    <h3>1. D·ª•ng C·ª•</h3>
                    <p>Tr√≤ ch∆°i s·ª≠ d·ª•ng 3 vi√™n x√∫c x·∫Øc, m·ªói vi√™n c√≥ 6 m·∫∑t t∆∞∆°ng ·ª©ng v·ªõi 6 linh v·∫≠t: <b>B·∫ßu, Cua, T√¥m,
                            C√°, Nai, G√†</b>.</p>
                </div>
                <div class="rule-item">
                    <h3>2. C√°ch ƒê·∫∑t C∆∞·ª£c</h3>
                    <p>Ng∆∞·ªùi ch∆°i d·ª± ƒëo√°n m·∫∑t n√†o s·∫Ω xu·∫•t hi·ªán v√† ƒë·∫∑t ti·ªÅn v√†o √¥ ƒë√≥. B·∫°n c√≥ th·ªÉ ƒë·∫∑t nhi·ªÅu c·ª≠a c√πng l√∫c.
                    </p>
                </div>
                <div class="rule-item"
                    style="background: #FFF9C4; padding: 10px; border-radius: 8px; border: 1px solid var(--accent-color);">
                    <h3>3. Tr·∫£ Th∆∞·ªüng (Payout)</h3>
                    <p>‚Ä¢ N·∫øu ra <b>1 m·∫∑t</b> b·∫°n ch·ªçn: Nh√† c√°i tr·∫£ l·∫°i ti·ªÅn c∆∞·ª£c + th∆∞·ªüng <b>x1</b> l·∫ßn.</p>
                    <p>‚Ä¢ N·∫øu ra <b>2 m·∫∑t</b> gi·ªëng nhau: Nh√† c√°i tr·∫£ l·∫°i ti·ªÅn c∆∞·ª£c + th∆∞·ªüng <b>x2</b> l·∫ßn.</p>
                    <p>‚Ä¢ N·∫øu ra <b>3 m·∫∑t</b> gi·ªëng nhau: Nh√† c√°i tr·∫£ l·∫°i ti·ªÅn c∆∞·ª£c + th∆∞·ªüng <b>x3</b> l·∫ßn.</p>
                </div>
                <div class="rule-item">
                    <h3>4. Thua C∆∞·ª£c</h3>
                    <p>N·∫øu m·∫∑t b·∫°n ch·ªçn kh√¥ng xu·∫•t hi·ªán, s·ªë ti·ªÅn c∆∞·ª£c s·∫Ω thu·ªôc v·ªÅ Nh√† C√°i.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeRules()" style="width: 100%;">ƒê√£ Hi·ªÉu</button>
            </div>
        </div>
    </div>

    <script>
        // --- JS LOGIC (ƒê√£ t·ªëi ∆∞u cho Mobile) ---
        const canvas = document.getElementById('fireworks-canvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particles = []; let isFireworksActive = false;

        class Particle {
            constructor(x, y, color) { this.x = x; this.y = y; this.color = color; const a = Math.random() * Math.PI * 2; const v = Math.random() * 6 + 2; this.dx = Math.cos(a) * v; this.dy = Math.sin(a) * v; this.alpha = 1; this.decay = Math.random() * 0.015 + 0.015; }
            draw() { ctx.save(); ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI * 2); ctx.fill(); ctx.restore(); }
            update() { this.x += this.dx; this.y += this.dy; this.dy += 0.05; this.dx *= 0.98; this.dy *= 0.98; this.alpha -= this.decay; }
        }
        function createFirework(x, y) { const colors = ['#f00', '#0f0', '#00f', '#ff0', '#f0f']; const c = colors[Math.floor(Math.random() * colors.length)]; for (let i = 0; i < 30; i++) particles.push(new Particle(x, y, c)); }
        function loopFW() { if (!isFireworksActive && particles.length === 0) { ctx.clearRect(0, 0, canvas.width, canvas.height); return; } requestAnimationFrame(loopFW); ctx.clearRect(0, 0, canvas.width, canvas.height); if (isFireworksActive && Math.random() < 0.05) createFirework(Math.random() * canvas.width, Math.random() * canvas.height / 2); particles.forEach((p, i) => { p.update(); p.draw(); if (p.alpha <= 0) particles.splice(i, 1); }); }
        function startFireworks() { isFireworksActive = true; loopFW(); for (let i = 0; i < 5; i++) createFirework(Math.random() * canvas.width, Math.random() * canvas.height / 2); setTimeout(() => { isFireworksActive = false; }, 5000); }

        function showStep2() { document.getElementById('step-1').style.display = 'none'; document.getElementById('step-2').style.display = 'block'; }
        function finishTutorial() { document.getElementById('tutorial-overlay').style.display = 'none'; const a = document.getElementById('bg-audio'); a.play().then(() => { isMusicPlaying = true; document.getElementById('music-icon').innerText = "üîä"; }).catch(() => { }); }

        let isMusicPlaying = false;
        function toggleMusic() { const a = document.getElementById('bg-audio'); const i = document.getElementById('music-icon'); if (isMusicPlaying) { a.pause(); i.innerText = "üîá"; isMusicPlaying = false; } else { a.play(); i.innerText = "üîä"; isMusicPlaying = true; } }

        function initFlowers() { setInterval(() => { const f = document.createElement('div'); f.className = 'falling-flower'; f.innerText = ['üå∏', 'üåº', 'üßß'][Math.floor(Math.random() * 3)]; f.style.left = Math.random() * 100 + 'vw'; f.style.fontSize = (Math.random() * 15 + 15) + 'px'; f.style.animationDuration = (Math.random() * 5 + 5) + 's'; document.body.appendChild(f); setTimeout(() => { f.remove() }, 10000); }, 800); }

        const SYMBOLS = [{ name: 'B·∫ßu', icon: 'üçê' }, { name: 'Cua', icon: 'ü¶Ä' }, { name: 'T√¥m', icon: 'ü¶ê' }, { name: 'C√°', icon: 'üêü' }, { name: 'Nai', icon: 'ü¶å' }, { name: 'G√†', icon: 'üêì' }];
        const AVATARS = { male: 'üë±‚Äç‚ôÇÔ∏è', female: 'üë©' };
        let dealer = { name: "Nh√† C√°i", balance: 10000 }, players = [], currentBets = [], gameState = "IDLE", diceResult = [0, 0, 0], showMoney = true, showSidebar = true;
        let xOffset = 0, yOffset = 0, active = false, initialX, initialY, currentX, currentY;

        function initGame() {
            for (let i = 1; i <= 6; i++) players.push({ id: i, name: `P${i}`, balance: 1000, gender: 'male' });
            renderBoard(); updateUI(); initBowlDrag(); initFlowers();
            // T·ª± ƒë·ªông ·∫©n sidebar tr√™n mobile khi m·ªõi v√†o
            if (window.innerWidth < 900) { showSidebar = false; document.getElementById('sidebar').classList.add('hidden'); document.getElementById('history-status').innerText = "·∫®n"; }
        }

        function handleGameAction() {
            if (gameState === "IDLE") {
                if (currentBets.length === 0) return alert("Ch∆∞a c∆∞·ª£c!");
                if (dealer.balance <= 0) return alert("Nh√† c√°i h·∫øt ti·ªÅn!");
                startShaking();
            } else if (gameState === "WAITING_OPEN") { openBowl(); }
        }

        function startShaking() {
            gameState = "SHAKING"; document.getElementById('btn-action').disabled = true; document.getElementById('btn-action').innerText = "ƒêang x√≥c...";
            const b = document.getElementById('the-bowl'); b.classList.remove('bowl-open'); b.style.transform = "translate(-50%,0)"; xOffset = 0; yOffset = 0;
            document.querySelectorAll('.dice').forEach(d => { d.classList.add('shaking'); d.innerText = "?"; });
            diceResult = [Math.floor(Math.random() * 6), Math.floor(Math.random() * 6), Math.floor(Math.random() * 6)];
            setTimeout(() => {
                document.querySelectorAll('.dice').forEach(d => d.classList.remove('shaking'));
                document.getElementById('d1').innerText = SYMBOLS[diceResult[0]].icon;
                document.getElementById('d2').innerText = SYMBOLS[diceResult[1]].icon;
                document.getElementById('d3').innerText = SYMBOLS[diceResult[2]].icon;
                gameState = "WAITING_OPEN";
                const btn = document.getElementById('btn-action'); btn.disabled = false; btn.innerText = "M·ªû B√ÅT"; btn.classList.add('btn-open');
            }, 1500);
        }

        function openBowl() {
            if (gameState !== "WAITING_OPEN") return;
            document.getElementById('the-bowl').classList.add('bowl-open');
            document.getElementById('sfx-clap').currentTime = 0; document.getElementById('sfx-clap').play().catch(() => { });
            startFireworks();
            setTimeout(() => { calculateResult(); const btn = document.getElementById('btn-action'); btn.innerText = "X√ìC TI·∫æP"; btn.classList.remove('btn-open'); gameState = "IDLE"; }, 500);
        }

        function calculateResult() {
            let counts = [0, 0, 0, 0, 0, 0]; diceResult.forEach(i => counts[i]++);
            let totalPay = 0, dealerProfit = 0;
            currentBets.forEach(bet => {
                const p = players.find(x => x.id == bet.playerId);
                const n = counts[bet.symbolIndex];
                if (n > 0) { const w = bet.amount * n; p.balance += (bet.amount + w); totalPay += w; log(`<span class="win">${p.name} ƒÉn ${SYMBOLS[bet.symbolIndex].name} (+${w})</span>`); }
                else { dealerProfit += bet.amount; log(`<span class="lose">${p.name} thua ${SYMBOLS[bet.symbolIndex].name} (-${bet.amount})</span>`); }
            });
            const net = dealerProfit - totalPay; dealer.balance += net;
            log(net >= 0 ? `<b>Nh√† c√°i l√£i: ${net}</b>` : `<b class="lose">Nh√† c√°i l·ªó: ${Math.abs(net)}</b>`);
            if (dealer.balance < 0) { alert("Nh√† c√°i s·∫≠p!"); dealer.balance = 0; }
            currentBets = []; updateUI(); renderBoard();
        }

        function handlePlaceBet() {
            if (gameState !== "IDLE") return alert("Ch·ªù v√°n sau!");
            const pid = document.getElementById('player-select').value;
            const sIdx = document.getElementById('selected-symbol-index').value;
            const amt = parseInt(document.getElementById('bet-amount').value);
            if (sIdx === "") return alert("Ch·ªçn h√¨nh tr∆∞·ªõc!");
            if (!amt || amt <= 0) return alert("Nh·∫≠p ti·ªÅn!");
            const p = players.find(x => x.id == pid);
            if (p.balance < amt) return alert("Kh√¥ng ƒë·ªß ti·ªÅn!");
            p.balance -= amt;
            currentBets.push({ playerId: pid, symbolIndex: parseInt(sIdx), amount: amt });
            updateUI(); renderBoardBetInfo();
            log(`${p.name} c∆∞·ª£c ${amt}$ v√†o ${SYMBOLS[sIdx].name}`);
        }

        function initBowlDrag() {
            const b = document.getElementById("the-bowl"); const c = document.querySelector(".dealer-section");
            const start = (e) => { if (gameState !== "WAITING_OPEN") return; active = true; const t = e.touches ? e.touches[0] : e; initialX = t.clientX - xOffset; initialY = t.clientY - yOffset; if (e.target !== b) active = false; };
            const end = () => { active = false; if (gameState === "WAITING_OPEN" && (Math.abs(xOffset) > 80 || Math.abs(yOffset) > 80)) openBowl(); else if (gameState === "WAITING_OPEN") { xOffset = 0; yOffset = 0; setTr(0, 0); } };
            const move = (e) => { if (!active) return; e.preventDefault(); const t = e.touches ? e.touches[0] : e; currentX = t.clientX - initialX; currentY = t.clientY - initialY; xOffset = currentX; yOffset = currentY; setTr(currentX, currentY); };
            const setTr = (x, y) => { b.style.transform = `translate(calc(-50% + ${x}px), ${y}px)`; };
            c.addEventListener("touchstart", start); c.addEventListener("touchend", end); c.addEventListener("touchmove", move);
            c.addEventListener("mousedown", start); window.addEventListener("mouseup", end); window.addEventListener("mousemove", move);
        }

        function renderBoard() {
            const b = document.getElementById('betting-board'); b.innerHTML = '';
            SYMBOLS.forEach((s, i) => {
                const d = document.createElement('div'); d.className = 'bet-option';
                d.onclick = () => {
                    document.getElementById('selected-symbol-name').value = s.name;
                    document.getElementById('selected-symbol-index').value = i;
                    document.querySelectorAll('.bet-option').forEach(e => e.classList.remove('selected')); d.classList.add('selected');
                };
                d.innerHTML = `<span class="symbol-icon">${s.icon}</span><span class="symbol-name">${s.name}</span><div class="current-bet-display" id="bet-display-${i}"></div>`;
                b.appendChild(d);
            });
        }
        function renderBoardBetInfo() { for (let i = 0; i < 6; i++)document.getElementById(`bet-display-${i}`).innerText = ""; let t = [0, 0, 0, 0, 0, 0]; currentBets.forEach(b => t[b.symbolIndex] += b.amount); t.forEach((v, i) => { if (v > 0) document.getElementById(`bet-display-${i}`).innerText = `${v}$`; }); }

        function updateUI() {
            document.getElementById('dealer-name-display').innerText = dealer.name; document.getElementById('dealer-balance').innerText = `Ti·ªÅn: ${dealer.balance}$`;
            const s = document.getElementById('player-select'); const old = s.value; s.innerHTML = '';
            players.forEach(p => { const o = document.createElement('option'); o.value = p.id; o.text = `${AVATARS[p.gender]} ${p.name}`; s.appendChild(o); });
            if (old) s.value = old;
            const pid = s.value || players[0].id; const pc = players.find(x => x.id == pid); if (pc) document.getElementById('current-player-balance').innerText = `(D∆∞: ${pc.balance}$)`;
            s.onchange = () => updateUI();
            const l = document.getElementById('player-list'); l.innerHTML = '';
            const dd = document.createElement('div'); dd.className = 'player-card dealer'; dd.innerHTML = `<span>üé© ${dealer.name}</span><span class="money-value">${dealer.balance}$</span>`; l.appendChild(dd);
            players.forEach(p => { const d = document.createElement('div'); d.className = 'player-card'; d.innerHTML = `<span>${AVATARS[p.gender]} ${p.name}</span><span class="money-value">${p.balance}$</span>`; l.appendChild(d); });
            applyHideMoney();
        }

        function toggleMoney() { showMoney = !showMoney; document.getElementById('money-status').innerText = showMoney ? "Hi·ªán" : "·∫®n"; updateUI(); }
        function applyHideMoney() { if (!showMoney) document.querySelectorAll('.money-value').forEach(e => e.innerText = "*****"); }
        function toggleSidebar() { showSidebar = !showSidebar; document.getElementById('history-status').innerText = showSidebar ? "Hi·ªán" : "·∫®n"; const s = document.getElementById('sidebar'); const c = document.getElementById('main-container'); if (showSidebar) { s.classList.remove('hidden'); c.classList.remove('hide-sidebar'); } else { s.classList.add('hidden'); c.classList.add('hide-sidebar'); } }
        function log(m) { const d = document.getElementById('game-log'); const e = document.createElement('div'); e.className = 'log-entry'; e.innerHTML = m; d.insertBefore(e, d.firstChild); }

        function openSettings() { document.getElementById('set-dealer-name').value = dealer.name; document.getElementById('set-dealer-money').value = dealer.balance; const c = document.getElementById('players-settings-container'); c.innerHTML = ''; players.forEach((p, i) => { const d = document.createElement('div'); d.className = 'form-group'; d.innerHTML = `<label>P${p.id}</label><input type="text" id="sn-${i}" value="${p.name}"><input type="number" id="sm-${i}" value="${p.balance}"><div style="display:flex;gap:5px"><label><input type="radio" name="g-${i}" value="male" ${p.gender == 'male' ? 'checked' : ''}>Nam</label><label><input type="radio" name="g-${i}" value="female" ${p.gender == 'female' ? 'checked' : ''}>N·ªØ</label></div>`; c.appendChild(d); }); document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        function saveSettings() { dealer.name = document.getElementById('set-dealer-name').value; dealer.balance = parseInt(document.getElementById('set-dealer-money').value); players.forEach((p, i) => { p.name = document.getElementById(`sn-${i}`).value; p.balance = parseInt(document.getElementById(`sm-${i}`).value); p.gender = document.querySelector(`input[name="g-${i}"]:checked`).value; }); updateUI(); closeSettings(); }

        function openRules() { document.getElementById('rules-modal').style.display = 'flex'; }
        function closeRules() { document.getElementById('rules-modal').style.display = 'none'; }

        window.onload = initGame;
        window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    </script>
</body>

</html>